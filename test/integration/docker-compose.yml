services:
  audio-router:
    build:
      context: ../..
      dockerfile: test/tilt/dockerfiles/Dockerfile.audio-router
    ports:
      - "9090:9090"
    volumes:
      - ./configs/audio-router-test.json:/app/config.json:ro
    command: ["/app/audio-router", "-config", "/app/config.json", "-verbose"]

  allstar-mock-1:
    build: ../containers/allstar-mock

  allstar-mock-2:
    build: ../containers/allstar-mock

  whotalkie-mock-1:
    build: ../containers/whotalkie-mock

  whotalkie-mock-2:
    build: ../containers/whotalkie-mock

  discord-mock:
    build: ../containers/discord-mock

  generic-mock:
    build: ../containers/generic-mock

  audio-generator:
    build: ../containers/audio-generator
    volumes:
      - ./audio-samples:/output
      - ./test-patterns:/patterns:ro
    command: ["/usr/local/bin/generate-test-audio.sh", "/output"]

  test-validator:
    build: ../containers/test-validator
    depends_on:
      - audio-router
      - allstar-mock-1
      - allstar-mock-2
      - whotalkie-mock-1
      - whotalkie-mock-2
      - discord-mock
    volumes:
      - ./test-results:/results
      - ./test-configs:/configs:ro

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9091:9090"
    volumes:
      - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./configs/grafana:/etc/grafana/provisioning:ro

volumes:
  prometheus-data: {}
  grafana-data: {}

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
